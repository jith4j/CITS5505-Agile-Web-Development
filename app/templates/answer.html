{% extends "navbar.html" %}

{% block content %}

<div class="container">
    <div class="content-wrap">
        <div class="question-info">
            <div class="wrap">
                <div class="author-avatar">
                    <img class="avatar" src="{{ question.author.avatar(36) }}">
                    <p class="author"><strong>{{ question.author.username }}</strong></p>
                </div>
                <p class="timestamp">{{ humanize.naturaltime(question.timestamp) }}</p>
            </div>
            <h1 class="text-center answer-heading">{{ question.question }}</h1>
        </div>

        {% if ans %}
        <div class="answer-cards">
            {% for a in ans %}
            <div class="answer-card">
                <div class="wrap">
                    <div class="author-avatar">
                        <img class="avatar" src="{{ a.author_avatar.avatar(36) }}">
                        <p class="author"><strong>{{ a.author }}</strong></p>
                    </div>
                    <p class="timestamp">{{ humanize.naturaltime(a.timestamp) }}</p>
                </div>
                <div class="answer-like-wrap">
                    <p class="answer-body">{{ a.answer }}</p>
                    <div class="likes">
                        <span id="likes-count-{{ a.id }}">{{ a.likes }}</span>
                        <span id="like-icon-{{ a.id }}" class="like-icon" onclick="toggleLike({{ a.id }})">
                            {% if a.user_liked %}
                            <i class="fas fa-heart" style="color: red;"></i>
                            {% else %}
                            <i class="far fa-heart" style="color: gray;"></i>
                            {% endif %}
                        </span>
                    </div>
                </div>

                <!-- Existing replies -->
                {% if a.all_replies %}
                <div class="reply-cards">
                    {% for reply in a.all_replies %}
                    <div class="reply-card">
                        <div class="wrap">
                            <div class="author-avatar">
                                <img class="avatar" src="{{ reply.author.avatar(36) }}">
                                <p class="author"><strong>{{ reply.author.username }}</strong></p>
                            </div>
                            <p class="timestamp">{{ humanize.naturaltime(reply.timestamp) }}</p>
                        </div>
                        <p class="reply-body">{{ reply.reply }}</p>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                <button class="btn-reply btn" onclick="toggleReplyForm({{ a.id }})">Reply</button>
                <div id="reply-form-{{ a.id }}" class="reply-form">
                    <form action="{{ url_for('add_reply', aid=a.id) }}" method="POST">
                        <textarea name="reply" placeholder="Reply to this answer..." required></textarea>
                        <button type="submit" class="btn btn-secondary btn-sm">Submit</button>
                        <button type="button" class="btn btn-danger btn-sm"
                            onclick="toggleReplyForm({{ a.id }})">Cancel</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-center text-heading">No answers found.</p>
        {% endif %}

        <div class="mt-4">
            <h4>Add Your Answer</h4>
            <form action="{{ url_for('add_answer', qid=question.id) }}" method="POST">
                <div class="form-group">
                    <label for="answer">Your Answer</label>
                    <textarea class="form-control" id="answer" name="answer" rows="3" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary btn-sm">Submit</button>
            </form>
        </div>
    </div>
</div>

<script>
    function toggleReplyForm(answerId) {
        var form = document.getElementById('reply-form-' + answerId);
        if (form.style.display === 'none' || form.style.display === '') {
            form.style.display = 'block';
        } else {
            form.style.display = 'none';
        }
    }

    function toggleLike(answerId) {
        var likeIcon = document.getElementById('like-icon-' + answerId);
        var likesCount = document.getElementById('likes-count-' + answerId);

        fetch(`/toggle_like/${answerId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(response => response.json()).then(data => {
            if (data.liked) {
                likeIcon.innerHTML = '<i class="fas fa-heart" style="color: red;"></i>';
            } else {
                likeIcon.innerHTML = '<i class="far fa-heart" style="color: gray;"></i>';
            }
            likesCount.textContent = data.likes;
        }).catch(error => {
            console.error('Error:', error);
        });
    }
</script>

{% endblock %}