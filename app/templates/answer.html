{% extends "navbar.html" %}

{% block content %}

<div class="container">
    <h3>Answers for: {{ question.question }}</h3>
    
    {% if ans %}
        <ul class="list-group">
            {% for a in ans %}
            <li class="list-group-item">
                {{ a.answer }} - by {{ a.author }} at {{ a.timestamp }} - <span id="likes-count-{{ a.id }}">{{ a.likes }}</span> <span id="like-icon-{{ a.id }}" class="like-icon" onclick="toggleLike({{ a.id }})">{{ '♥' if a.user_liked else '♡' }}</span>
                <!-- Display existing replies for each answer -->
                {% if a.all_replies %}
                    <ul>
                        {% for reply in a.all_replies %}
                            <li>{{ reply.reply }} - <small>by {{ reply.author.username }} at {{ reply.timestamp }}</small></li>
                        {% endfor %}
                    </ul>
                {% endif %}
                <!-- Reply button -->
                <button class="btn-reply" onclick="toggleReplyForm({{ a.id }})">Reply</button>
                <!-- Form to submit a new reply -->
                <div id="reply-form-{{ a.id }}" class="reply-form">
                    <form action="{{ url_for('add_reply', aid=a.id) }}" method="POST">
                        <textarea name="reply" placeholder="Reply to this answer..." required></textarea>
                        <button type="submit" class="btn btn-secondary btn-sm">Submit</button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="toggleReplyForm({{ a.id }})">Cancel</button>
                    </form>
                </div>
            </li>
            {% endfor %}
        </ul>
    {% else %}
    <p>No answers found.</p>
    {% endif %}

    <!-- Form to add a new answer -->
    <div class="mt-4">
        <h4>Add Your Answer</h4>
        <form action="{{ url_for('add_answer', qid=question.id) }}" method="POST">
            <div class="form-group">
                <label for="answer">Your Answer</label>
                <textarea class="form-control" id="answer" name="answer" rows="3" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary btn-sm">Submit</button>
        </form>
    </div>
</div>

<script>
function toggleReplyForm(answerId) {
    var form = document.getElementById('reply-form-' + answerId);
    if (form.style.display === 'none' || form.style.display === '') {
        form.style.display = 'block';
    } else {
        form.style.display = 'none';
    }
}

function toggleLike(answerId) {
    var likeIcon = document.getElementById('like-icon-' + answerId);
    var likesCount = document.getElementById('likes-count-' + answerId);

    fetch(`/toggle_like/${answerId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    }).then(response => response.json()).then(data => {
        if (data.liked) {
            likeIcon.textContent = '♥';
        } else {
            likeIcon.textContent = '♡';
        }
        likesCount.textContent = data.likes;
    }).catch(error => {
        console.error('Error:', error);
    });
}
</script>

{% endblock %}
